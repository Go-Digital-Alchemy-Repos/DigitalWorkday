You are continuing development on my existing single-codebase React + Express app.
This is PHASE 3A (SAFER): Tenant Provisioning + Tenant Admin Onboarding Wizard with “inactive until onboarded” gating.
DO NOT rewrite the app. Implement ONLY the features described below in a SAFE, NON-DESTRUCTIVE, backwards-compatible way.

===============================================================================
ABSOLUTE NON-NEGOTIABLE SAFETY RULES
===============================================================================
- DO NOT remove or rename any existing endpoints.
- DO NOT change response shapes in a breaking way.
- DO NOT drop or rename DB tables/columns. Add-only schema changes only.
- DO NOT overhaul authentication/session/token strategy.
- DO NOT refactor unrelated features (projects/tasks/time tracking/comments/etc.) unless explicitly needed for tenant gating.
- Keep existing tenants working; do not lock out current production tenants.

===============================================================================
KEY SAFETY DESIGN
===============================================================================
- New tenants start as status="inactive".
- Only onboarding routes are accessible for tenant admins of inactive tenants.
- Once onboarding completes, tenant is marked status="active" and onboardedAt set.
- Existing tenants in production must be treated as active/onboarded automatically (via safe migration/backfill rules described below).

===============================================================================
PREREQUISITES ASSUMED
===============================================================================
- Phase 1 + Phase 2A/2B exist (tenants table, tenantId columns, tenantContext middleware, super_user role).
- A Super Admin bootstrap exists or will be run separately.

===============================================================================
GOAL
===============================================================================
Enable SaaS tenant lifecycle:
1) Super User creates tenant (inactive), invites tenant admin
2) Tenant admin logs in and is forced through onboarding
3) Onboarding configures tenant settings + mailgun per tenant
4) Completing onboarding activates tenant, unlocking the full app

===============================================================================
1) DATA MODEL (ADD-ONLY)
===============================================================================
A) Tenants onboarding state
If missing, add:
- tenants.onboardedAt (timestamp nullable)
- tenants.ownerUserId (uuid nullable FK users.id)
- tenants.status should support: "inactive" | "active" | "suspended"

B) Tenant settings table (preferred)
tenant_settings:
- id (uuid)
- tenantId (uuid unique FK tenants.id)
- displayName (text)
- logoUrl (text nullable)
- primaryColor (text nullable)
- supportEmail (text nullable)
- createdAt, updatedAt

C) Backfill for existing deployments (CRITICAL)
To avoid locking out existing tenants:
- If you already have a default tenant that contains all existing data, mark it:
  - tenants.status="active"
  - tenants.onboardedAt = now() if null
- For any existing tenants created before this change:
  - if they have any users or data and status is null/unknown, treat them as active and set onboardedAt safely (migration).

IMPORTANT:
- This must be done via migration/backfill script, not runtime logic.

===============================================================================
2) TENANT STATUS GATING (MANDATORY)
===============================================================================
Implement server-side guard middleware:
- /server/src/middleware/tenantStatusGuard.ts

Behavior:
- If request is from non-super_user AND effectiveTenantId exists:
  - Load tenant by effectiveTenantId
  - If tenant.status != "active":
    - Allow ONLY these routes:
      - /api/v1/auth/* (login/me/logout/forgot/reset)
      - /api/v1/tenant/* (tenant onboarding endpoints)
      - /api/v1/settings/mailgun* (only if used by onboarding step)
    - All other routes return 403 with:
      { error: { code:"TENANT_INACTIVE", message:"Tenant onboarding incomplete." } }

- Super user is never blocked by tenant status.

Frontend guard:
- If user is tenant admin and tenant inactive:
  - redirect to /onboarding and block other pages

===============================================================================
3) SUPER USER: TENANT PROVISIONING APIs (ADD-ONLY OR EXTEND EXISTING)
===============================================================================
super_user only:

- GET  /api/v1/super/tenants
- POST /api/v1/super/tenants
  Body: { name, slug? }
  Behavior:
    - create tenant with status="inactive"
    - create tenant_settings with displayName=name
    - return tenant

- PATCH /api/v1/super/tenants/:tenantId
  Body: { name?, slug?, status? }  // super can activate/suspend manually too

- POST /api/v1/super/tenants/:tenantId/invite-admin
  Body: { email, firstName?, lastName?, expiresInDays? }
  Behavior:
    - create invitation with tenantId and role="admin"
    - return invite link + token
    - if system mail is configured, email it; otherwise return link only

- GET /api/v1/super/tenants/:tenantId/onboarding-status
  Returns: { status, onboardedAt, ownerUserId }

Notes:
- Do not break existing invitations. Add tenantId field to invitations if missing (nullable for legacy).
- Invite acceptance must set the created admin user.tenantId = invitation.tenantId.

===============================================================================
4) TENANT ADMIN: ONBOARDING WIZARD (FRONTEND + BACKEND)
===============================================================================
A) On login (tenant-scoped admin):
If tenant.status != "active" OR tenant.onboardedAt is null:
- Force /onboarding (frontend)
- Server guard blocks other APIs (backend)

B) Onboarding UI: /onboarding
Steps:

Step 1: Tenant Profile
- displayName (editable)
- supportEmail (optional)
Save -> PATCH /api/v1/tenant/settings

Step 2: Branding
- logo upload (use existing upload flow; store logoUrl; base64 ok only if that’s current pattern)
- primaryColor (hex input ok)
Save -> PATCH /api/v1/tenant/settings

Step 3: Mailgun (per-tenant)
- domain
- api key (write-only, encrypted at rest)
- from email
- save shows configured status + masked key
- send test email to current admin
Endpoints:
- GET/PUT /api/v1/settings/mailgun (tenant-scoped)
- POST /api/v1/settings/mailgun/test

Step 4: Finish
- “Complete Setup” button:
  POST /api/v1/tenant/onboarding/complete

Server side onboarding complete:
- set tenants.onboardedAt = now()
- set tenants.status = "active"
- set tenants.ownerUserId = current user id (first admin)
Return success.

C) Tenant onboarding endpoints (tenant admin only, tenant-scoped)
- GET  /api/v1/tenant/me
  returns: { tenant, tenantSettings, user }
- PATCH /api/v1/tenant/settings
  body: { displayName?, logoUrl?, primaryColor?, supportEmail? }
- GET  /api/v1/tenant/onboarding/status
- POST /api/v1/tenant/onboarding/complete

Authorization:
- Only admin within that tenant can call these
- super_user may call them optionally but not required

D) After onboarding completion:
- Frontend redirects to home (/clients)
- Normal navigation unlocked

===============================================================================
5) SUPER USER UI (MINIMAL + SAFE)
===============================================================================
/super/tenants page:
- list tenants with status + onboarded indicator
- create tenant (inactive)
- edit tenant
- invite admin (copy link)
Optional:
- “Act as tenant” button for super_user (sets X-Tenant-Id in requests) — super only

===============================================================================
6) SECURITY REQUIREMENTS
===============================================================================
- Never return raw Mailgun API key to client
- Never log secrets
- If encryption key missing in production, return clear error; do not silently clear

===============================================================================
7) TESTS (MANDATORY MINIMUM)
===============================================================================
Add tests:

1) super.tenants.lifecycle.test.ts
- super creates tenant -> status inactive
- super invites admin -> invitation includes tenantId + role=admin

2) tenantStatusGuard.test.ts
- tenant admin in inactive tenant:
  - can call /api/v1/tenant/me
  - cannot call /api/v1/clients (403 TENANT_INACTIVE)
- after onboarding complete:
  - can call /api/v1/clients successfully

3) onboarding.complete.test.ts
- completing onboarding sets status active + onboardedAt + ownerUserId

4) mailgun.tenant.test.ts
- mailgun settings remain tenant-scoped

===============================================================================
8) ACCEPTANCE CRITERIA (MUST WORK)
===============================================================================
1) New tenants are inactive until onboarding is completed.
2) Tenant admin of inactive tenant is forced into /onboarding.
3) While tenant inactive, all non-onboarding APIs are blocked for tenant users (403 TENANT_INACTIVE).
4) Completing onboarding activates tenant and unlocks full app.
5) Existing tenants/data are not locked out (migration marks them active/onboarded).
6) No endpoints broken; existing workflows continue.
7) Tests pass.

===============================================================================
OUTPUT REQUIRED
===============================================================================
- Summary of changes
- Migrations added (add-only + backfill behavior)
- New endpoints added
- Middleware added (tenantStatusGuard)
- Manual test steps for super_user -> tenant admin onboarding lifecycle
