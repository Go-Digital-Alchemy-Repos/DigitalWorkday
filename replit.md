# MyWorkDay - Project Management Application

## Overview
MyWorkDay is an Asana-inspired project management application designed to streamline project workflows and enhance team collaboration. It centralizes project and client management, offering tools for organizing projects, teams, and clients with features like workspaces, tasks, subtasks, tags, comments, and activity tracking. The application aims to improve productivity through robust reporting and real-time communication. Key capabilities include multi-tenancy, comprehensive client relationship management (CRM) with a client portal, workload management, and a focus on a professional, intuitive user experience.

## User Preferences
- Professional, clean Asana-like design
- Board view as primary view with list view and calendar view options
- **Database migrations**: When pushing schema changes, preserve existing data - only update schema structure, never wipe the database. Use Drizzle migrations (`drizzle-kit generate` + `drizzle-kit migrate`) instead of `drizzle-kit push` for production deployments.
- Calendar view displays tasks with due dates using FullCalendar, with filtering by client/project/assignee/scope; read-only visualization with task detail drawer on click. Uses lightweight CalendarTask DTO (id, title, status, priority, dueDate, projectId, assignees) for performance - full task data fetched on demand when clicked.
- My Tasks view with two viewing modes: date-based grouping (overdue, today, tomorrow, upcoming) and personal sections organization
- Projects Dashboard with search, status/client/team filters, table view showing project details via drawer, and budget utilization indicators
- Workload Reports in Settings showing task distribution by employee with completion metrics
- Workload Forecast with task time estimates, project budgets, budget tracking, and workload distribution by assignee
- **Theme Packs**: 14 curated color schemes (light, dark, midnight, graphite, forest, ocean, violet, rose, amber, slate, sand, arctic, espresso, cyber). Accessible via the sun/moon toggle in the header and the Appearance card in User Profile. Stored in `themePackId` column of `user_ui_preferences` table; `themeMode` kept as legacy-safe "light"/"dark"/"system". Tenant default via `defaultThemePack` in `tenant_settings`. Resolution chain: `themePackId ?? themeMode ?? tenantDefaultThemePack ?? "light"`. Unknown pack IDs safely fall back to "light". Theme packs are defined in `client/src/theme/themePacks.ts`, applied via `ThemeProvider` CSS custom properties.

## System Architecture

### Tech Stack
- **Frontend**: React 18, TypeScript, Tailwind CSS, shadcn/ui, React Query, FullCalendar
- **Backend**: Express.js, TypeScript, Socket.IO
- **Database**: PostgreSQL with Drizzle ORM
- **Routing**: Wouter (frontend)
- **State Management**: React Query
- **Real-time**: Socket.IO

### Core Features and Design Patterns
- **Multi-Tenancy**: Supports multiple tenants with an admin dashboard, white-label branding, and per-tenant user management.
- **Authentication**: Session-based authentication using Passport.js (email/password, Google OAuth).
- **Real-time Communication**: Socket.IO for live updates, supporting tenant-scoped chat, threaded replies, and notifications.
- **Project & Task Management**: Includes workspaces, teams, clients, projects, tasks with subtasks, activity logs, and time tracking. Supports project templates and rich text comments with @mentions.
- **Client Relationship Management (CRM)**: Comprehensive client detail pages with notes, documents (Cloudflare R2), client pipeline tracking, contacts, and an external client portal. Features a Client 360 View, profitability reports, approval workflows, and client-safe messaging. Includes **Thread Merge & Duplicate Detection**: admins can merge duplicate conversation threads via "Merge With..." action in Client 360 Messages tab. Merge moves all messages from secondary thread to primary, closes secondary with `mergedIntoId` FK tracking, inserts `[Thread Merged]` audit message. Duplicate detection endpoint finds same-subject conversations within ±5 minutes. Merged conversations excluded from list views. Schema columns: `mergedIntoId`, `mergedAt`, `mergedByUserId` on `client_conversations`. Socket event: `CLIENT_CONVERSATION_EVENTS.MERGED`. Functionality is controlled by environment-driven feature flags.
- **Workload Management**: Provides workload forecasting and reporting based on task distribution and budget utilization.
- **Notifications**: Customizable, real-time notification system with a Notification Center.
- **User Experience**: Global command palette, keyboard shortcuts, dark mode, CSS-variable-based accent color theming, and Framer Motion animations. Implements mobile-first responsive design and consistent drawer UI.
- **Modular Architecture**: API routes organized by domain via `routeRegistry` + `routerFactory` (migrated) and legacy aggregator. Centralized query key builders in `client/src/lib/queryKeys.ts`. Frontend routing split into role-based modules in `client/src/routing/`: `guards.ts` (auth guard components), `tenantRouter.tsx` (tenant layout + routes), `superRouter.tsx` (super-admin layout + routes), `portalRouter.tsx` (client portal layout + routes). App.tsx is a thin composition root (providers + role selection). See `docs/architecture/organization.md` for full details.
- **Storage Layer Architecture**: `server/storage.ts` contains IStorage interface and DatabaseStorage class (~4100 lines). Domain-specific implementations extracted into `server/storage/` repos: `chat.repo.ts` (channels, DMs, messages, search, attachments, read tracking), `support.repo.ts` (tickets, canned replies, macros, SLA policies, form schemas), `notifications.repo.ts` (CRUD, preferences), `clients.repo.ts`, `projects.repo.ts`, `tasks.repo.ts`, `timeTracking.repo.ts`. DatabaseStorage delegates to repo instances. All repos use `import { db } from "@db"`.
- **Route Sub-Routers**: Large domain routers split into sub-directory modules. `server/http/domains/chat/` has `channels.routes.ts`, `messages.routes.ts`, `dm.routes.ts`, `search.routes.ts`, `shared.ts`, `index.ts` (aggregator). `server/http/domains/time/` has `timers.routes.ts`, `entries.routes.ts`, `reports.routes.ts`, `calendar.routes.ts`, `shared.ts`, `index.ts` (aggregator). Parent router files (`chat.router.ts`, `time.router.ts`) are thin re-exports.
- **Super Admin Component Architecture**: `tenant-drawer.tsx` (parent shell ~1060 lines) delegates to 12 sub-components in `client/src/components/super-admin/tenant-drawer/` (overview, onboarding, workspaces, users, clients, projects, branding, integrations, notes + types.ts, shared-components.tsx, index.ts). `super-admin-status.tsx` (parent ~253 lines) delegates to 10 section components in `client/src/components/super-admin/status/` (system-health, tenant-health, auth-diagnostics, debug-tools, tenant-health-repair, chat-debug, db-introspect, error-log, email-logs + types.ts, shared-components.tsx).
- **Performance & Robustness**: Utilizes DB performance indexes, optimized React Query usage, list virtualization, error boundaries, graceful shutdown mechanisms, and **route-based code splitting** via `React.lazy` + `Suspense` across all three layout routers (`tenantRouter`, `superRouter`, `portalRouter`) and `App.tsx`. All page components are lazily loaded, reducing the initial JS bundle from ~3.8 MB to ~517 kB (86% reduction). See `docs/performance/frontend-bundle.md` for details.
- **Security Hardening**: Features tenancy enforcement, defense-in-depth tenant scoping, standardized API error handling, rate limiting on critical endpoints, CSRF protection, and secret redaction in logs. API error envelope standardized with `ok`, `requestId`, `error.{code,message,status,requestId,details}` across all 5 emission points (errorHandler, sendError, handleRouteError, validateBody helper, validateBody middleware). ZodError caught by handleRouteError producing 400 VALIDATION_ERROR. See `docs/architecture/api-contracts.md`.
- **Background Job Queue**: DB-backed (`background_jobs` table) in-process job queue for long-running operations (Asana imports, CSV imports, bulk task imports, AI generation). Per-type concurrency limits, progress tracking, status polling via REST API (`/api/v1/jobs`), stale lock recovery, graceful shutdown. Core files: `server/jobs/queue.ts`, `server/jobs/handlers.ts`, `server/jobs/jobs.router.ts`. See `docs/architecture/jobs.md`.
- **Support Ticketing System**: Multi-tenant support ticket & work order system with dual interfaces. Schema: `support_tickets`, `support_ticket_messages`, `support_ticket_events` tables with 7 enums (status, priority, category, source, author_type, visibility, event_type). Tenant console at `/support` with full CRUD, status transitions, priority management, assignee, filtering (status/priority/category/search), internal notes vs public replies. Client portal at `/portal/support` with create/list/detail/reply. API routes: tenant `/api/v1/support/*`, portal `/api/v1/portal/support/*`. Socket events defined in `shared/events/index.ts` (SUPPORT_TICKET_EVENTS). Core files: `server/http/domains/support.router.ts`, `server/features/client-portal/support.router.ts`, `client/src/pages/support-tickets.tsx`, `client/src/pages/support-ticket-detail.tsx`, `client/src/pages/client-portal-support*.tsx`.
- **Support Canned Replies & Macros**: Reusable message templates (canned replies) and automation macros for the tenant support console. Schema: `support_canned_replies` (title, bodyText, visibility, workspaceId) and `support_macros` (title, bodyText, visibility, actionsJson with setStatus/setPriority/assignToUserId, workspaceId). CRUD API at `/api/v1/support/canned-replies/*` and `/api/v1/support/macros/*`. Apply macro via `POST /api/v1/support/tickets/:id/apply-macro` (atomically inserts message + applies actions + logs audit event). Management UI at `/support/templates` with tabs for replies and macros. Ticket detail composer has "Insert Reply" and "Apply Macro" dropdown buttons with macro preview/confirm dialog. Core files: `client/src/pages/support-templates.tsx`, `client/src/pages/support-ticket-detail.tsx`.
- **SLA Tracking & Escalation**: Schema: `support_sla_policies` (tenantId, workspaceId, category, priority, firstResponseMinutes, resolutionMinutes, escalationJson). Ticket columns: `firstResponseAt`, `firstResponseBreachedAt`, `resolutionBreachedAt`, `metadataJson`. SLA policy matching: most-specific-first (workspace+category+priority → tenant+category → tenant+priority). Auto-set `firstResponseAt` on first public tenant reply. Background SLA evaluator runs every 5 minutes, logs `sla_breach` events. CRUD API at `/api/v1/support/sla-policies/*`. Manual trigger: `POST /api/v1/support/sla-evaluate`. Management UI at `/support/sla-policies`. Ticket list shows "SLA Breached" badges; ticket detail shows SLA Status card. Core files: `client/src/pages/support-sla-policies.tsx`, `server/http/domains/support.router.ts`.
- **Category-Specific Ticket Forms**: Schema: `support_ticket_form_schemas` (tenantId, workspaceId, category, schemaJson). Dynamic JSON schema per category with field types: text, textarea, select, number, date, checkbox. CRUD API at `/api/v1/support/form-schemas/*`. Portal GET at `/api/v1/portal/support/form-schemas/:category`. Portal create ticket page dynamically renders custom fields based on category schema, stores in `metadataJson` on ticket. Ticket detail shows "Request Details" card with custom field values. Management UI at `/support/form-schemas` with visual field editor. Core files: `client/src/pages/support-form-schemas.tsx`, `client/src/pages/client-portal-support-new.tsx`.
- **Observability**: Implements request IDs for end-to-end correlation, structured request logging, and error logging to the database. Includes health endpoints for liveness and readiness checks.

## External Dependencies
- **PostgreSQL**: Primary database.
- **Socket.IO**: Real-time communication.
- **FullCalendar**: Calendar UI component.
- **Passport.js**: Authentication library.
- **Railway**: Deployment platform.
- **Mailgun**: Email service.
- **Cloudflare R2**: Object storage for files.